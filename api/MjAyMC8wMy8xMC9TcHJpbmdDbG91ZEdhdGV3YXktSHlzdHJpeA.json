{"title":"SpringCloudGateway-Hystrix","date":"2020-03-10T13:01:11.000Z","date_formatted":{"ll":"Mar 10, 2020","L":"03/10/2020","MM-DD":"03-10"},"link":"2020/03/10/SpringCloudGateway-Hystrix","comments":true,"tags":["Gateway","Hystrix"],"categories":["SpringCloud"],"updated":"2020-03-11T02:30:30.677Z","content":"<p>此篇承接之前的博文<a href=\"https://blog.bugbak.com/2020/03/06/SpringCloudGateway\" target=\"_blank\">SpringCloudGateway</a>，建议从SpringCloud-Gateway看起</p>\n<h1 id=\"接入hystrix\">接入Hystrix<a href=\"#接入hystrix\" title=\"接入Hystrix\"></a></h1><p>application.yml中配置如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">hystrix_route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://localhost:8081</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Hystrix</span></span><br><span class=\"line\">              <span class=\"attr\">args:</span></span><br><span class=\"line\">                <span class=\"attr\">name:</span> <span class=\"string\">HystrixCommend</span></span><br><span class=\"line\">                <span class=\"comment\">#熔断时调用接口/fallback</span></span><br><span class=\"line\">                <span class=\"attr\">fallbackUri:</span> <span class=\"string\">forward:/fallback</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/test/get</span></span><br><span class=\"line\"><span class=\"attr\">hystrix:</span></span><br><span class=\"line\">  <span class=\"attr\">metrics:</span></span><br><span class=\"line\">    <span class=\"comment\">#设置超时时间2s，请求超过两秒就熔断</span></span><br><span class=\"line\">    <span class=\"attr\">polling-interval-ms:</span> <span class=\"number\">2000</span></span><br></pre></td></tr></table></figure>\n\n<p>启动类上添加注解@RestController，并添加如下代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping</span>(value = <span class=\"string\">\"/fallback\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> Mono&lt;Map&lt;String, Object&gt;&gt; fallback(ServerWebExchange exchange, Throwable throwable) &#123;</span><br><span class=\"line\">    Map&lt;String, Object&gt; result = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">    ServerHttpRequest request = exchange.getRequest();</span><br><span class=\"line\">    result.put(<span class=\"string\">\"path\"</span>, request.getPath().pathWithinApplication().value());</span><br><span class=\"line\">    result.put(<span class=\"string\">\"method\"</span>, request.getMethodValue());</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> != throwable.getCause()) &#123;</span><br><span class=\"line\">        result.put(<span class=\"string\">\"message\"</span>, throwable.getCause().getMessage());</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        result.put(<span class=\"string\">\"message\"</span>, throwable.getMessage());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Mono.just(result);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>新建一个小项目用于测试，编写接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"meta\">@RequestMapping</span>(<span class=\"string\">\"/test\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping</span>(<span class=\"string\">\"/get\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">get</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            TimeUnit.SECONDS.sleep(<span class=\"number\">3</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"ok\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>测试结果如下：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;<span class=\"attr\">\"path\"</span>:<span class=\"string\">\"/fallback\"</span>,<span class=\"attr\">\"method\"</span>:<span class=\"string\">\"GET\"</span>,<span class=\"attr\">\"message\"</span>:<span class=\"literal\">null</span>&#125;</span><br></pre></td></tr></table></figure>\n\n<p>没有返回ok说明已熔断保护，调用/fallback</p>\n","next":{"title":"SpringGateway-RateLimiter","link":"2020/03/09/SpringCloudGateway-RateLimiter"},"plink":"https://blog.bugbak.com/2020/03/10/SpringCloudGateway-Hystrix/","toc":[{"id":"接入hystrix","title":"接入Hystrix","index":"1"}],"reward":true,"copyright":{"author":"Dz","link":"<a href=\"https://blog.bugbak.com/2020/03/10/SpringCloudGateway-Hystrix/\" title=\"SpringCloudGateway-Hystrix\">https://blog.bugbak.com/2020/03/10/SpringCloudGateway-Hystrix/</a>","license":"本博客所有文章除特别声明外，均采用(<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"nofollow\" target=\"_blank\">CC BY-NC-SA 4.0</a>)许可协议，转载请注明来源<a href=\"https://blog.bugbak.com\" rel=\"nofollow\" target=\"_blank\">BugBak</a>"}}