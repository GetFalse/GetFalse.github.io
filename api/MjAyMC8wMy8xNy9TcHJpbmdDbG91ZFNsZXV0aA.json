{"title":"SpringCloudSleuth","date":"2020-03-17T11:01:11.000Z","date_formatted":{"ll":"Mar 17, 2020","L":"03/17/2020","MM-DD":"03-17"},"link":"2020/03/17/SpringCloudSleuth","comments":true,"tags":["Sleuth","Zipkin"],"categories":["SpringCloud"],"updated":"2020-03-18T02:44:51.152Z","content":"<h1 id=\"什么是springcloudsleuth\">什么是SpringCloudSleuth<a href=\"#什么是springcloudsleuth\" title=\"什么是SpringCloudSleuth\"></a></h1><p>分布式服务跟踪</p>\n<h1 id=\"如何接入springcloudsleuth\">如何接入SpringCloudSleuth<a href=\"#如何接入springcloudsleuth\" title=\"如何接入SpringCloudSleuth\"></a></h1><p>分别在生产者和消费者中引入依赖</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>编写测试类，输出日志如下</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2020</span>-<span class=\"number\">03</span>-<span class=\"number\">17</span> <span class=\"number\">11</span>:<span class=\"number\">13</span>:<span class=\"number\">20.587</span>  INFO [eureka-client-consume,<span class=\"number\">14f</span>f8837105039d6,<span class=\"number\">6416620f</span>d7783eaf,<span class=\"keyword\">false</span>] <span class=\"number\">15288</span> --- [LIB$$<span class=\"number\">90315295</span>-<span class=\"number\">2</span>] c.b.e.EurekaClientConsumeApplication     : 发起调用</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2020</span>-<span class=\"number\">03</span>-<span class=\"number\">17</span> <span class=\"number\">11</span>:<span class=\"number\">13</span>:<span class=\"number\">20.592</span>  INFO [eureka-client,<span class=\"number\">14f</span>f8837105039d6,a77a7d1125f96e57,<span class=\"keyword\">false</span>] <span class=\"number\">17732</span> --- [nio-<span class=\"number\">8081</span>-exec-<span class=\"number\">5</span>] c.b.e.EurekaClientApplication            : 接受调用</span><br></pre></td></tr></table></figure>\n\n<p>可以看到，日志里出现了<code>[eureka-client-consume,14ff8837105039d6,6416620fd7783eaf,false]</code>信息，这些信息由Spring Cloud Sleuth生成，用于跟踪微服务请求链路。这些信息包含了4个部分的值，它们的含义如下：</p>\n<ol><li><code>eureka-client-consume</code>微服务的名称，与<code>spring.application.name</code>对应；</li><li><code>14ff8837105039d6</code>称为<strong>Trace ID</strong>，在一条完整的请求链路中，这个值是固定的。观察上面的日志即可证实这一点；</li><li><code>6416620fd7783eaf</code>称为<strong>Span ID</strong>，它表示一个基本的工作单元；</li><li><code>false</code>表示是否要将该信息输出到Zipkin等服务中来收集和展示，这里我们还没有集成Zipkin，所以为false</li></ol><h1 id=\"引入zipkin收集日志\">引入Zipkin收集日志<a href=\"#引入zipkin收集日志\" title=\"引入Zipkin收集日志\"></a></h1><p>springboot2.2.*之后不推荐自定义Zipkin-server，所有我我们去官网下载jar包直接运行，<a href=\"https://zipkin.io/pages/quickstart.html，\" target=\"_blank\">https://zipkin.io/pages/quickstart.html，</a></p>\n<p>在消费者和生产者中引入</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>application.yml中添加</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span> </span><br><span class=\"line\">  <span class=\"attr\">zipkin:</span></span><br><span class=\"line\">    <span class=\"attr\">base-url:</span> <span class=\"string\">http://localhost:9411</span></span><br></pre></td></tr></table></figure>\n\n<p>启动生产者和消费者就，调用接口，就可以在<a href=\"http://localhost:9411追踪调用链了。\" target=\"_blank\">http://localhost:9411追踪调用链了。</a></p>\n","prev":{"title":"Ribbon+RestTemplate","link":"2020/10/12/Ribbon+RestTemplate"},"next":{"title":"Swagger2","link":"2020/03/16/Swagger2"},"plink":"https://blog.bugbak.com/2020/03/17/SpringCloudSleuth/","toc":[{"id":"什么是springcloudsleuth","title":"什么是SpringCloudSleuth","index":"1"},{"id":"如何接入springcloudsleuth","title":"如何接入SpringCloudSleuth","index":"2"},{"id":"引入zipkin收集日志","title":"引入Zipkin收集日志","index":"3"}],"reward":true,"copyright":{"author":"Dz","link":"<a href=\"https://blog.bugbak.com/2020/03/17/SpringCloudSleuth/\" title=\"SpringCloudSleuth\">https://blog.bugbak.com/2020/03/17/SpringCloudSleuth/</a>","license":"本博客所有文章除特别声明外，均采用(<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"nofollow\" target=\"_blank\">CC BY-NC-SA 4.0</a>)许可协议，转载请注明来源<a href=\"https://blog.bugbak.com\" rel=\"nofollow\" target=\"_blank\">BugBak</a>"}}