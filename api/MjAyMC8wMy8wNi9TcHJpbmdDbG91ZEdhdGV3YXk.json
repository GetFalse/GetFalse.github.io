{"title":"SpringCloudGateway","date":"2020-03-06T20:01:11.000Z","date_formatted":{"ll":"Mar 6, 2020","L":"03/06/2020","MM-DD":"03-06"},"link":"2020/03/06/SpringCloudGateway","comments":true,"tags":["Gateway"],"categories":["SpringCloud"],"updated":"2020-03-11T02:22:17.527Z","content":"<h1 id=\"搭建环境\">搭建环境<a href=\"#搭建环境\" title=\"搭建环境\"></a></h1><p><del>SpringBoot2.1.3</del>，SpringBoot: 2.2.0.RELEASE<br><del>SpringCloud: Greenwich.SR2</del>，SpringCloud: Hoxton.RELEASE<br>JDK1.8.0_162<br>Maven3.5.3</p>\n<h1 id=\"spring-cloud-gateway是什么\">Spring Cloud Gateway是什么<a href=\"#spring-cloud-gateway是什么\" title=\"Spring Cloud Gateway是什么\"></a></h1><p>Gateway是在Spring生态系统之上构建的API网关服务。说白了就是服务的出入口，请求都是从这进从这出。这里有三个概念。</p>\n<ul><li>Route（路由）：路由是构建网关的基本模块，它由ID，目标URI，一系列的断言和过滤器组成，如果断言为true则匹配该路由；</li><li>Predicate（断言）：指的是Java 8 的 Function Predicate。 输入类型是Spring框架中的ServerWebExchange。 这使开发人员可以匹配HTTP请求中的所有内容，例如请求头或请求参数。如果请求与断言相匹配，则进行路由；</li><li>Filter（过滤器）：指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前后对请求进行修改。</li></ul><h1 id=\"工作原理\">工作原理<a href=\"#工作原理\" title=\"工作原理\"></a></h1><p><img src=\"https://resource.bugbak.com//bZjUKSKeQPxZs2cLKriUdgJRcZbH7OaqUS3tiNw5.png\" class=\"φcy\"></p>\n<p>客户端向Spring Cloud Gateway发出请求。如果网关处理映射器确定请求与路由匹配，则将其发送到网关Web处理器。该处理程序通过特定于请求的过滤器链来运行请求。筛选器由虚线分隔的原因是，筛选器可以在发送代理请求之前和之后运行逻辑。所有“前置”过滤器逻辑均被执行。然后发出代理请求。发出代理请求后，将运行”后”过滤器逻辑。</p>\n<h1 id=\"搭建一个spring-cloud-gateway项目\">搭建一个Spring Cloud Gateway项目<a href=\"#搭建一个spring-cloud-gateway项目\" title=\"搭建一个Spring Cloud Gateway项目\"></a></h1><p>接下来我们一步步的搭建一个Spring Cloud Gateway项目。首先新建一个springboot项目项目名叫gateway。通过maven管理依赖，配置如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">project</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://maven.apache.org/POM/4.0.0\"</span> <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema-instance\"</span></span></span><br><span class=\"line\"><span class=\"tag\">         <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">modelVersion</span>&gt;</span>4.0.0<span class=\"tag\">&lt;/<span class=\"name\">modelVersion</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">parent</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-parent<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.1.9.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">relativePath</span>/&gt;</span> <span class=\"comment\">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">parent</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.bugbak<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>gateway<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>0.0.1-SNAPSHOT<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>gateway<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">description</span>&gt;</span>Demo project for Spring Boot<span class=\"tag\">&lt;/<span class=\"name\">description</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">java.version</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">java.version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-dependencies<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>Greenwich.SR2<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">type</span>&gt;</span>pom<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>import<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencyManagement</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-contract-stub-runner<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-web<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-test<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>test<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">build</span>&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">project</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>然后等待依赖下载完毕，这里强调一下，依赖里不能出现spring-boot-starter-web，否者启动会报错，原因是Spring Cloud Gateway需要Spring Boot和Spring Webflux提供的Netty运行。它不能在传统的Servlet容器中或作为WAR构建时使用。</p>\n<h2 id=\"配置路由的断言\">配置路由的断言<a href=\"#配置路由的断言\" title=\"配置路由的断言\"></a></h2><p>然后我们在<strong>application.yml</strong>文件中加入如下配置</p>\n<h3 id=\"时间断言\">时间断言<a href=\"#时间断言\" title=\"时间断言\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span> <span class=\"comment\">#路由器的名字，重复没有报错,不知为何</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span> <span class=\"comment\">#匹配成功后使用这个地址</span></span><br><span class=\"line\">        <span class=\"attr\">predicates:</span></span><br><span class=\"line\">          <span class=\"comment\">#在这个时间之后请求才有效</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">After=2020-03-09T17:28:30.407+08:00[Asia/Shanghai]</span></span><br><span class=\"line\">          <span class=\"comment\">#在这个时间之前请求才有效</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">Before=2020-03-08T17:28:30.407+08:00[Asia/Shanghai]</span></span><br><span class=\"line\">          <span class=\"comment\">#在这个时间之间请求才有效，前面值必须小于后面，否者报错</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">Between=2020-03-08T17:28:30.407+08:00[Asia/Shanghai],2020-03-09T17:28:30.407+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"http参数断言\">Http参数断言<a href=\"#http参数断言\" title=\"Http参数断言\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#匹配cookie里面名字为 chocolate，值为符合ch.p正则表达式的值比如chap</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">Cookie=chocolate,</span> <span class=\"string\">ch.p</span></span><br><span class=\"line\"><span class=\"comment\">#匹配头里面名字为X-Request-Id，值为符合\\d+正则表达式的比如这里是匹配数值</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">Header=X-Request-Id,</span> <span class=\"string\">\\d+</span></span><br><span class=\"line\"><span class=\"comment\">#匹配头里面Host，符合下面的表达式，比如a.somehost.org</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">Host=**.somehost.org,**.anotherhost.org</span></span><br><span class=\"line\"><span class=\"comment\">#sub可在ServerWebExchange.getAttributes()，ServerWebExchangeUtils.URI_TEMPLATE_VARIABLES_ATTRIBUT，GatewayFilter</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">Host=&#123;sub&#125;.xxhost.com</span></span><br><span class=\"line\"><span class=\"comment\">#匹配请求方式GET，POST都支持</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">Method=GET,POST</span></span><br><span class=\"line\"><span class=\"comment\">#Map&lt;String, String&gt; uriVariables = ServerWebExchangeUtils.getPathPredicateVariables(exchange);</span></span><br><span class=\"line\"><span class=\"comment\">#String segment = uriVariables.get(\"segment\");</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">Path=/red/&#123;segment&#125;,/blue/&#123;segment&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#匹配请求参数，这里有一个必须的参数，和一个可选的正则表达式参数，</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">Query=name</span></span><br><span class=\"line\"><span class=\"comment\">#请求参数里有个参数名name，且他的值符合正则表达式deng.比如deng1</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">Query=name,</span> <span class=\"string\">deng.</span></span><br><span class=\"line\"><span class=\"comment\">#匹配调用者的ip地址，24为子网掩码，注意如果调用者使用了代理，这个值就是代理ip地址，可以使用X-Forwarded-For解决这个问题</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">RemoteAddr=127.0.0.1/24</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"权重断言\">权重断言<a href=\"#权重断言\" title=\"权重断言\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"comment\">#权重配置，有两个参数一个是group，如下group1和group2,以及weight是int型数值。</span></span><br><span class=\"line\">  <span class=\"comment\">#如下配置就是80%的走http://httpbin1.org,20%的走http://httpbin2.org</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">weight_high</span></span><br><span class=\"line\">  <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin1.org</span></span><br><span class=\"line\">  <span class=\"attr\">predicates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">Weight=group1,</span> <span class=\"number\">8</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">Path=/post</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">weight_low</span></span><br><span class=\"line\">  <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin2.org</span></span><br><span class=\"line\">  <span class=\"attr\">predicates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">Weight=group1,</span> <span class=\"number\">2</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br></pre></td></tr></table></figure>\n\n<p>以上皆测试所得，这里重点阐述一下权重配置。就我测试结果观察。就是有80%几率走httpbin1，不管里面是否会匹配，比如我配置的路径是/post, 我请求的路径是/get，他还是会走httpbin1。如果我在weight_high，weight_low中间再穿插一个规则，也是符合的请求的，那么百分百不走weight_low。给我的感觉就是由上而下进行执行直到匹配上规则，走到weight_high的时候判断一下80%的概率是否执行，不执行就往下走，而不是跳到weight_low执行。</p>\n<p>各位小伙伴可以自行测试，如果没有修改端口的话，就执行<a href=\"http://localhost:8080/get\" target=\"_blank\">http://localhost:8080/get</a> 就可以测试了， 这里有个小坑，大家注意一下，如果报错如下，大家看是否spring-boot-starter-parent版本高于2.2.0,如果高于，就把版本降低到这个版本以下。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2020</span>-<span class=\"number\">03</span>-<span class=\"number\">08</span> <span class=\"number\">20</span>:<span class=\"number\">37</span>:<span class=\"number\">08.334</span> ERROR <span class=\"number\">7812</span> --- [ctor-http-nio-<span class=\"number\">3</span>] reactor.netty.http.server.HttpServer     : [id: <span class=\"number\">0x3e6a4c38</span>, L:/<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">1</span>:<span class=\"number\">8080</span> - R:/<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">0</span>:<span class=\"number\">1</span>:<span class=\"number\">51078</span>] </span><br><span class=\"line\"></span><br><span class=\"line\">java.lang.NoSuchMethodError: reactor.netty.http.client.HttpClient.chunkedTransfer(Z)Lreactor/netty/http/client/HttpClient;</span><br><span class=\"line\">\tat org.springframework.cloud.gateway.filter.NettyRoutingFilter.filter(NettyRoutingFilter.java:<span class=\"number\">125</span>) ~[spring-cloud-gateway-core-<span class=\"number\">2.1</span><span class=\"number\">.2</span>.RELEASE.jar:<span class=\"number\">2.1</span><span class=\"number\">.2</span>.RELEASE]</span><br><span class=\"line\">\tat org.springframework.cloud.gateway.handler.FilteringWebHandler$GatewayFilterAdapter.filter(FilteringWebHandler.java:<span class=\"number\">138</span>) ~[spring-cloud-gateway-core-<span class=\"number\">2.1</span><span class=\"number\">.2</span>.RELEASE.jar:<span class=\"number\">2.1</span><span class=\"number\">.2</span>.RELEASE]</span><br><span class=\"line\">\tat org.springframework.cloud.gateway.filter.OrderedGatewayFilter.filter(OrderedGatewayFilter.java:<span class=\"number\">44</span>) ~[spring-cloud-gateway-core-<span class=\"number\">2.1</span><span class=\"number\">.2</span>.RELEASE.jar:<span class=\"number\">2.1</span><span class=\"number\">.2</span>.RELEASE]</span><br><span class=\"line\">\tat org.springframework.cloud.gateway.handler.FilteringWebHandler$DefaultGatewayFilterChain.lambda$filter$<span class=\"number\">0</span>(FilteringWebHandler.java:<span class=\"number\">118</span>) ~[spring-cloud-gateway-core-<span class=\"number\">2.1</span><span class=\"number\">.2</span>.RELEASE.jar:<span class=\"number\">2.1</span><span class=\"number\">.2</span>.RELEASE]</span><br><span class=\"line\">\tat reactor.core.publisher.MonoDefer.subscribe(MonoDefer.java:<span class=\"number\">44</span>) ~[reactor-core-<span class=\"number\">3.3</span><span class=\"number\">.3</span>.RELEASE.jar:<span class=\"number\">3.3</span><span class=\"number\">.3</span>.RELEASE]</span><br><span class=\"line\">\tat reactor.core.publisher.MonoDefer.subscribe(MonoDefer.java:<span class=\"number\">52</span>) ~[reactor-core-<span class=\"number\">3.3</span><span class=\"number\">.3</span>.RELEASE.jar:<span class=\"number\">3.3</span><span class=\"number\">.3</span>.RELEASE]</span><br><span class=\"line\">\tat reactor.core.publisher.MonoDefer.subscribe(MonoDefer.java:<span class=\"number\">52</span>) ~[reactor-core-<span class=\"number\">3.3</span><span class=\"number\">.3</span>.RELEASE.jar:<span class=\"number\">3.3</span><span class=\"number\">.3</span>.RELEASE]</span><br><span class=\"line\">\tat reactor.core.publisher.MonoDefer.subscribe(MonoDefer.java:<span class=\"number\">52</span>) ~[reactor-core-<span class=\"number\">3.3</span><span class=\"number\">.3</span>.RELEASE.jar:<span class=\"number\">3.3</span><span class=\"number\">.3</span>.RELEASE]</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"配置路由的过滤器\">配置路由的过滤器<a href=\"#配置路由的过滤器\" title=\"配置路由的过滤器\"></a></h2><h3 id=\"addrequestheader\">AddRequestHeader<a href=\"#addrequestheader\" title=\"AddRequestHeader\"></a></h3><p>这里我新建了一个<strong>application-dev.yml</strong>，原来的<strong>application.yml</strong>中加入配置</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">profiles:</span></span><br><span class=\"line\">    <span class=\"attr\">active:</span> <span class=\"string\">dev</span></span><br></pre></td></tr></table></figure>\n\n<p>dev配置如下:</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br></pre></td></tr></table></figure>\n\n<p>我在测试是否存在覆盖的时候，发现配置上面这种情况。<strong>application.yml</strong>中的routes全部失效。这点的确没有想到。目前的结论是无法分文件配置，只能写在一个文件里面。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"comment\">#添加请求头X-Request-re:blue</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddRequestHeader=X-Request-red,</span> <span class=\"string\">blue</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br></pre></td></tr></table></figure>\n\n<p>上图我再次测试了是不是按顺序进行匹配的，测试结果是没有加请求头X-Request-red，所以就是上面说的，匹配到，就结束。</p>\n<p>还有一种就是predicates中设置的变量filters中可以使用如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">          <span class=\"comment\">#添加请求头参数red:blue-&#123;segment&#125;，segment是取去请求Path里面的值</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddRequestHeader=X-Request-red,</span> <span class=\"string\">blue-&#123;segment&#125;</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/anything/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>这种情况测试没有成功，这下我有经验了，我将spring-cloud-dependencies版本升级了了，spring-boot-starter-parent也升级了，配置如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-parent<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.2.0.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-dependencies<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>Hoxton.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>结果他成功了，真是不让人不省心啊。。。。然后我趁热打铁测了一下上面覆盖的问题，发现问题还是存在<strong>application.yml</strong>中的routes还是全部失效。</p>\n<h3 id=\"addrequestparameter\">AddRequestParameter<a href=\"#addrequestparameter\" title=\"AddRequestParameter\"></a></h3><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"comment\">#添加请求参数red=blue-&#123;segment&#125;，segment是取去请求Path里面的值</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddRequestParameter=red,</span> <span class=\"string\">blue-&#123;segment&#125;</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/anything/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"addresponseheader\">AddResponseHeader<a href=\"#addresponseheader\" title=\"AddResponseHeader\"></a></h3><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"comment\">#添加响应头red=blue-&#123;segment&#125;，segment是取去请求Path里面的值</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Red,</span> <span class=\"string\">Blue</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/anything/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"deduperesponseheader\">DedupeResponseHeader<a href=\"#deduperesponseheader\" title=\"DedupeResponseHeader\"></a></h3><p>这个就是干掉重复的响应头，有人肯定就会迷惑，怎么会出现重复的响应头，刚好本人在开发中遇到过这个问题，就是在解决跨域问题，我程序里面加了一个Access-Control-Allow-Origin:*，然后运维在nginx上也加了一个，所以出现了两个一样的响应头。既然有两个，肯定是有保留哪一个的问题，这个提供3种<code>RETAIN_FIRST</code>（这个是默认项，保留第一个），<code>RETAIN_LAST</code>(保留最后一个)，<code>RETAIN_UNIQUE</code>(保留唯一的)</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Red,</span> <span class=\"string\">Blue1</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Red,</span> <span class=\"string\">Blue2</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Yellow,</span> <span class=\"string\">Blue3</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Yellow,</span> <span class=\"string\">Blue3</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Yellow,</span> <span class=\"string\">Blue4</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/anything/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>我们先给他添一下响应头，响应头结果如下</p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 <span class=\"number\">200</span> OK</span><br><span class=\"line\"><span class=\"attribute\">X-Response-Red</span>: Blue1</span><br><span class=\"line\"><span class=\"attribute\">X-Response-Red</span>: Blue2</span><br><span class=\"line\"><span class=\"attribute\">X-Response-Yellow</span>: Blue3</span><br><span class=\"line\"><span class=\"attribute\">X-Response-Yellow</span>: Blue3</span><br><span class=\"line\"><span class=\"attribute\">X-Response-Yellow</span>: Blue4</span><br><span class=\"line\"><span class=\"attribute\">Date</span>: Sun, 08 Mar 2020 16:12:42 GMT</span><br><span class=\"line\"><span class=\"attribute\">Content-Type</span>: application/json</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 652</span><br><span class=\"line\"><span class=\"attribute\">Server</span>: gunicorn/19.9.0</span><br><span class=\"line\"><span class=\"attribute\">Access-Control-Allow-Origin</span>: *</span><br><span class=\"line\"><span class=\"attribute\">Access-Control-Allow-Credentials</span>: true</span><br></pre></td></tr></table></figure>\n\n<p>这个时候我们加入DedupeResponseHeader</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Red,</span> <span class=\"string\">Blue1</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Red,</span> <span class=\"string\">Blue2</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Yellow,</span> <span class=\"string\">Blue3</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Yellow,</span> <span class=\"string\">Blue3</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Yellow,</span> <span class=\"string\">Blue4</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">DedupeResponseHeader=X-Response-Red,RETAIN_LAST</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">DedupeResponseHeader=X-Response-Yellow,RETAIN_UNIQUE</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/anything/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>运行结果如下</p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 <span class=\"number\">200</span> OK</span><br><span class=\"line\"><span class=\"attribute\">Date</span>: Sun, 08 Mar 2020 16:19:52 GMT</span><br><span class=\"line\"><span class=\"attribute\">Content-Type</span>: application/json</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 652</span><br><span class=\"line\"><span class=\"attribute\">Server</span>: gunicorn/19.9.0</span><br><span class=\"line\"><span class=\"attribute\">Access-Control-Allow-Origin</span>: *</span><br><span class=\"line\"><span class=\"attribute\">Access-Control-Allow-Credentials</span>: true</span><br><span class=\"line\"><span class=\"attribute\">X-Response-Yellow</span>: Blue3</span><br><span class=\"line\"><span class=\"attribute\">X-Response-Yellow</span>: Blue4</span><br><span class=\"line\"><span class=\"attribute\">X-Response-Red</span>: Blue2</span><br></pre></td></tr></table></figure>\n\n<p>结果一目了然，X-Response-Red保留最后就是Blue2,X-Response-Yellow保留唯一的就是删掉了重复的Blue3，还有一种写法，如果都采用默认策略，可以直接这样写，两个响应头之间用空格隔开。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"string\">DedupeResponseHeader=X-Response-Red</span> <span class=\"string\">X-Response-Yellow</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"circuitbreaker\">CircuitBreaker<a href=\"#circuitbreaker\" title=\"CircuitBreaker\"></a></h3><p>首先解释一下，这个玩意叫断路器。这里支持两种Hystrix和Resilience4J。官方文档推荐Resilience4J，说Hystrix现在被标记为只维护了。然后我去招聘网上在深圳收了一下Resilience4J，一家都没有…..然后又搜了一下Hystrix，就只有5家……实话说我也只对Hystrix眼熟，所以这里我们主要讨论一下Hystrix。由于篇幅原因，我在另一篇博文里面专门讲解。</p>\n<h3 id=\"maprequestheader\">MapRequestHeader<a href=\"#maprequestheader\" title=\"MapRequestHeader\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddRequestHeader=X-Request-1,</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddRequestHeader=X-Request-2,</span> <span class=\"number\">2</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">MapRequestHeader=X-Request-1,X-Request-2</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/anything/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>说白了就是复制一个和X-Request-1一样的值的请求头X-Request-2，如果XRequest-2之前就已经存在，就把原来的值包括进去。记住是复制一个，原来的头还在那里，看下图的结果就明白了</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"args\"</span>: &#123;&#125;, </span><br><span class=\"line\">  <span class=\"attr\">\"data\"</span>: <span class=\"string\">\"\"</span>, </span><br><span class=\"line\">  <span class=\"attr\">\"files\"</span>: &#123;&#125;, </span><br><span class=\"line\">  <span class=\"attr\">\"form\"</span>: &#123;&#125;, </span><br><span class=\"line\">  <span class=\"attr\">\"headers\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"Accept\"</span>: <span class=\"string\">\"*/*\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Accept-Encoding\"</span>: <span class=\"string\">\"gzip,deflate\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Content-Length\"</span>: <span class=\"string\">\"0\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Forwarded\"</span>: <span class=\"string\">\"proto=http;host=\\\"localhost:8080\\\";for=\\\"127.0.0.1:61222\\\"\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Host\"</span>: <span class=\"string\">\"httpbin.org\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"User-Agent\"</span>: <span class=\"string\">\"Apache-HttpClient/4.5.8 (Java/11.0.3)\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"X-Amzn-Trace-Id\"</span>: <span class=\"string\">\"Root=1-5e65bea6-8c228e8c8017cd5df1ff75a5\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"X-Forwarded-Host\"</span>: <span class=\"string\">\"localhost:8080\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"X-Request-1\"</span>: <span class=\"string\">\"1\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"X-Request-2\"</span>: <span class=\"string\">\"2,1\"</span></span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  <span class=\"attr\">\"json\"</span>: <span class=\"literal\">null</span>, </span><br><span class=\"line\">  <span class=\"attr\">\"method\"</span>: <span class=\"string\">\"GET\"</span>, </span><br><span class=\"line\">  <span class=\"attr\">\"origin\"</span>: <span class=\"string\">\"127.0.0.1, 113.57.247.0\"</span>, </span><br><span class=\"line\">  <span class=\"attr\">\"url\"</span>: <span class=\"string\">\"http://localhost:8080/anything/haha\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>然后我测试了一下filters是不是有顺序的，将MapRequestHeader移到最上面，结果是没有生效，所以filters是按顺序执行的。然后我测试了之前的DedupeResponseHeader放在上面，发现没有影响，我猜他每个部分有一个整体顺序，每个部分的内部是按配置顺序来，反正按照逻辑顺序写就对了。</p>\n<h3 id=\"prefixpath\">PrefixPath<a href=\"#prefixpath\" title=\"PrefixPath\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">PrefixPath=/anything</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br></pre></td></tr></table></figure>\n\n<p>把匹配到的路径加一个前缀/anything，<a href=\"http://localhost:8080/get的结果就变成了http://localhost:8080/anything/get\" target=\"_blank\">http://localhost:8080/get的结果就变成了http://localhost:8080/anything/get</a></p>\n<h3 id=\"preservehostheader\">PreserveHostHeader<a href=\"#preservehostheader\" title=\"PreserveHostHeader\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">PreserveHostHeader</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br></pre></td></tr></table></figure>\n\n<p>没加PreserveHostHeader</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"args\"</span>: &#123;&#125;, </span><br><span class=\"line\">  <span class=\"attr\">\"headers\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"Accept\"</span>: <span class=\"string\">\"*/*\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Accept-Encoding\"</span>: <span class=\"string\">\"gzip,deflate\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Content-Length\"</span>: <span class=\"string\">\"0\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Forwarded\"</span>: <span class=\"string\">\"proto=http;host=\\\"localhost:8080\\\";for=\\\"127.0.0.1:62728\\\"\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Host\"</span>: <span class=\"string\">\"httpbin.org\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"User-Agent\"</span>: <span class=\"string\">\"Apache-HttpClient/4.5.8 (Java/11.0.3)\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"X-Amzn-Trace-Id\"</span>: <span class=\"string\">\"Root=1-5e65c53a-6e62e57803de635ad7a1795c\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"X-Forwarded-Host\"</span>: <span class=\"string\">\"localhost:8080\"</span></span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  <span class=\"attr\">\"origin\"</span>: <span class=\"string\">\"127.0.0.1, 113.57.247.0\"</span>, </span><br><span class=\"line\">  <span class=\"attr\">\"url\"</span>: <span class=\"string\">\"http://localhost:8080/get\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>加了PreserveHostHeader</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"args\"</span>: &#123;&#125;, </span><br><span class=\"line\">  <span class=\"attr\">\"headers\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"attr\">\"Accept\"</span>: <span class=\"string\">\"*/*\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Accept-Encoding\"</span>: <span class=\"string\">\"gzip,deflate\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Content-Length\"</span>: <span class=\"string\">\"0\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Forwarded\"</span>: <span class=\"string\">\"proto=http;host=\\\"localhost:8080\\\";for=\\\"127.0.0.1:62634\\\"\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"Host\"</span>: <span class=\"string\">\"localhost\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"User-Agent\"</span>: <span class=\"string\">\"Apache-HttpClient/4.5.8 (Java/11.0.3)\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"X-Amzn-Trace-Id\"</span>: <span class=\"string\">\"Root=1-5e65c4fe-aa95f72094a2cfa02e0408e0\"</span>, </span><br><span class=\"line\">    <span class=\"attr\">\"X-Forwarded-Host\"</span>: <span class=\"string\">\"localhost:8080\"</span></span><br><span class=\"line\">  &#125;, </span><br><span class=\"line\">  <span class=\"attr\">\"origin\"</span>: <span class=\"string\">\"127.0.0.1, 113.57.247.0\"</span>, </span><br><span class=\"line\">  <span class=\"attr\">\"url\"</span>: <span class=\"string\">\"http://localhost:8080/get\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>差别在Host请求头上，PreserveHostHeader没有参数，意思是保留Host头，加了就是用请求url上的host，不加就是路由配置uri里面host</p>\n<h3 id=\"requestratelimiter\">RequestRateLimiter<a href=\"#requestratelimiter\" title=\"RequestRateLimiter\"></a></h3><p>限流这一块没有快捷配置，我们单独拿出来讲解。</p>\n<h3 id=\"redirectto\">RedirectTo<a href=\"#redirectto\" title=\"RedirectTo\"></a></h3><p>重定向，有两个参数一个status，一个url。status对应是300系列的重定向状态码。下图配置就是返回一个状态码为302，然后响应头里面有一个Location: <a href=\"https://baidu.com，说白了就是跳转到百度\" target=\"_blank\">https://baidu.com，说白了就是跳转到百度</a></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">RedirectTo=302,https://baidu.com</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"removerequestheader\">RemoveRequestHeader<a href=\"#removerequestheader\" title=\"RemoveRequestHeader\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddRequestHeader=X-Request-1,</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"comment\">#如果存在则移除请求头X-Request-1</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">RemoveRequestHeader=X-Request-1</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"removeresponseheader\">RemoveResponseHeader<a href=\"#removeresponseheader\" title=\"RemoveResponseHeader\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Request-1,</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"comment\">#如果存在则移除响应头X-Request-1</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">RemoveRequestHeader=X-Request-1</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br></pre></td></tr></table></figure>\n\n<p>如果有一个公共的响应头，里面的值过于敏感，不能显示给调用者，然后一个个的添加过滤很显然不符合实际，这个时候有一个全局过滤default-filters。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">default-filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">RemoveResponseHeader=X-Response-Red</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Red,</span> <span class=\"string\">Blue1</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"removerequestparameter\">RemoveRequestParameter<a href=\"#removerequestparameter\" title=\"RemoveRequestParameter\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"comment\">#添加请求头移除请求参数name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">RemoveRequestParameter=name</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/get</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"rewritepath\">RewritePath<a href=\"#rewritepath\" title=\"RewritePath\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">RewritePath=/red(?&lt;segment&gt;/?.*),</span> <span class=\"string\">$\\&#123;segment&#125;</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/anything/**</span></span><br></pre></td></tr></table></figure>\n\n<p>按照正则表达式重写路径，RewritePath有两个参数第一个是正则表达式，第二个是替换的参数。上面的配置就是访问<a href=\"http://localhost:8080/anything/red/blue，被替换成http://localhost:8080/anything/blue。\" target=\"_blank\">http://localhost:8080/anything/red/blue，被替换成http://localhost:8080/anything/blue。</a></p>\n<h3 id=\"rewritelocationresponseheader\">RewriteLocationResponseHeader<a href=\"#rewritelocationresponseheader\" title=\"RewriteLocationResponseHeader\"></a></h3><p>还没测试貌似有点绕，先贴个官方示例</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">rewritelocationresponseheader_route</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">http://example.org</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">RewriteLocationResponseHeader=AS_IN_REQUEST,</span> <span class=\"string\">Location,</span> <span class=\"string\">,</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"rewriteresponseheader\">RewriteResponseHeader<a href=\"#rewriteresponseheader\" title=\"RewriteResponseHeader\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://httpbin.org</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/anything/**</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">AddResponseHeader=X-Response-Red,</span> <span class=\"string\">password=123</span></span><br><span class=\"line\">            <span class=\"comment\">#修改响应头里面的值，以下三个变量分别代表：响应头名字、正则表达示匹配内容、替换上的值</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">RewriteResponseHeader=X-Response-Red,</span> <span class=\"string\">password=[^&amp;]+,</span> <span class=\"string\">password=***</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"savesession\">SaveSession<a href=\"#savesession\" title=\"SaveSession\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">save_session</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">https://example.org</span></span><br><span class=\"line\">        <span class=\"attr\">predicates:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">Path=/foo/**</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">SaveSession</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"secureheaders\">SecureHeaders<a href=\"#secureheaders\" title=\"SecureHeaders\"></a></h3><p>添加一响应头，默认如下</p>\n<ul><li><code>X-Xss-Protection:1 (mode=block</code>)</li><li><code>Strict-Transport-Security (max-age=631138519</code>)</li><li><code>X-Frame-Options (DENY)</code></li><li><code>X-Content-Type-Options (nosniff)</code></li><li><code>Referrer-Policy (no-referrer)</code></li><li><code>Content-Security-Policy (default-src &#39;self&#39; https:; font-src &#39;self&#39; https: data:; img-src &#39;self&#39; https: data:; object-src &#39;none&#39;; script-src https:; style-src &#39;self&#39; https: &#39;unsafe-inline)&#39;</code></li><li><code>X-Download-Options (noopen)</code></li><li><code>X-Permitted-Cross-Domain-Policies (none)</code></li></ul><h3 id=\"setpath\">SetPath<a href=\"#setpath\" title=\"SetPath\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">setpath_route</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">https://example.org</span></span><br><span class=\"line\">        <span class=\"attr\">predicates:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">Path=/red/&#123;segment&#125;</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">SetPath=/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"setrequestheader\">SetRequestHeader<a href=\"#setrequestheader\" title=\"SetRequestHeader\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">setrequestheader_route</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">https://example.org</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">SetRequestHeader=X-Request-Red,</span> <span class=\"string\">Blue</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">setrequestheader_route</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">https://example.org</span></span><br><span class=\"line\">        <span class=\"attr\">predicates:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">Host:</span> <span class=\"string\">&#123;segment&#125;.myhost.org</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">SetRequestHeader=foo,</span> <span class=\"string\">bar-&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"setresponseheader\">SetResponseHeader<a href=\"#setresponseheader\" title=\"SetResponseHeader\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">setresponseheader_route</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">https://example.org</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">SetResponseHeader=X-Response-Red,</span> <span class=\"string\">Blue</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">setresponseheader_route</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">https://example.org</span></span><br><span class=\"line\">        <span class=\"attr\">predicates:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">Host:</span> <span class=\"string\">&#123;segment&#125;.myhost.org</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">SetResponseHeader=foo,</span> <span class=\"string\">bar-&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"setstatus\">SetStatus<a href=\"#setstatus\" title=\"SetStatus\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">setstatusstring_route</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">https://example.org</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">SetStatus=BAD_REQUEST</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">setstatusint_route</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">https://example.org</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">SetStatus=401</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">set-status:</span></span><br><span class=\"line\">      <span class=\"comment\">#可以将原来的响应码放在这个头里，如果正常响应则original-http-status: [200]</span></span><br><span class=\"line\">        <span class=\"attr\">original-status-header-name:</span> <span class=\"string\">original-http-status</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"stripprefix\">StripPrefix<a href=\"#stripprefix\" title=\"StripPrefix\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">nameRoot</span></span><br><span class=\"line\">        <span class=\"attr\">uri:</span> <span class=\"string\">https://nameservice</span></span><br><span class=\"line\">        <span class=\"attr\">predicates:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">Path=/name/**</span></span><br><span class=\"line\">        <span class=\"attr\">filters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">StripPrefix=2</span></span><br></pre></td></tr></table></figure>\n\n<p>通过网关/name/blue/red发出请求时，请求路径变成/red</p>\n<h3 id=\"retry\">Retry<a href=\"#retry\" title=\"Retry\"></a></h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">route</span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">http://localhost:8081</span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/test/get</span></span><br><span class=\"line\">          <span class=\"attr\">filters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">Retry</span></span><br><span class=\"line\">              <span class=\"attr\">args:</span></span><br><span class=\"line\">                <span class=\"comment\">#重试三次，加上第一次一共四次</span></span><br><span class=\"line\">                <span class=\"attr\">retries:</span> <span class=\"number\">3</span></span><br><span class=\"line\">                <span class=\"comment\">#响应码为502进行重试</span></span><br><span class=\"line\">                <span class=\"attr\">status:</span> <span class=\"number\">502</span></span><br><span class=\"line\">                <span class=\"comment\">#请求方法是GET，或者Post才重试</span></span><br><span class=\"line\">                <span class=\"attr\">methods:</span> <span class=\"string\">GET,POST</span></span><br><span class=\"line\">                <span class=\"comment\">#一系列响应码就是5开头就是服异常，不能写数值，与status同时配置，status失效 #INFORMATIONAL(1),SUCCESSFUL(2),REDIRECTION(3),CLIENT_ERROR(4),SERVER_ERROR(5);</span></span><br><span class=\"line\">                <span class=\"attr\">series:</span> <span class=\"string\">CLIENT_ERROR</span></span><br><span class=\"line\">                <span class=\"comment\">#应该重试的异常列表，我这样配置没有生效</span></span><br><span class=\"line\">                <span class=\"attr\">exceptions:</span> <span class=\"string\">java.io.IOException</span></span><br><span class=\"line\">                <span class=\"comment\">#下面几个参数没搞明白</span></span><br><span class=\"line\">                <span class=\"attr\">backoff:</span></span><br><span class=\"line\">                  <span class=\"attr\">firstBackoff:</span> <span class=\"string\">10ms</span></span><br><span class=\"line\">                  <span class=\"attr\">maxBackoff:</span> <span class=\"string\">50ms</span></span><br><span class=\"line\">                  <span class=\"attr\">factor:</span> <span class=\"number\">2</span></span><br><span class=\"line\">                  <span class=\"attr\">basedOnPreviousValue:</span> <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n\n<p>如果直接开启默认配置如下，一般开启默认就行了- Retry</p>\n<ul><li><p><code>retries</code>: Three times</p></li><li><p><code>series</code>: 5XX series</p></li><li><p><code>methods</code>: GET method</p></li><li><p><code>exceptions</code>: <code>IOException</code> and <code>TimeoutException</code></p></li><li><p><code>backoff</code>: disabled</p><h3 id=\"requestsize\">RequestSize<a href=\"#requestsize\" title=\"RequestSize\"></a></h3><p>现在上传数据大小,默认是5MB，超过了会提示</p><p>HTTP/1.1 413 Request Entity Too Large<br>errorMessage: Request size is larger than permissible limit. Request size is 1.4 MB where permissible limit is 1.0 kB</p><h3 id=\"modifyrequestbody\">ModifyRequestBody<a href=\"#modifyrequestbody\" title=\"ModifyRequestBody\"></a></h3><p>这个只能用JAVA DSL配置，如下示例</p><h3 id=\"modifyresponsebody\">ModifyResponseBody<a href=\"#modifyresponsebody\" title=\"ModifyResponseBody\"></a></h3><p>这个只能用JAVA DSL配置，如下示例</p><h3 id=\"default-filters\">default-filters<a href=\"#default-filters\" title=\"default-filters\"></a></h3><p>默认过滤对全局生效，之前的应都支持</p></li></ul><h1 id=\"总结\">总结<a href=\"#总结\" title=\"总结\"></a></h1><p>这次给我最大的感悟就是，在引入包的时候，版本一定要统一！一定要统一！一定要统一！重要的事情说3遍，2.2.x就对应2.2.x，千万被跨大版本，要不然各种坑！</p>\n<h1 id=\"参考\">参考<a href=\"#参考\" title=\"参考\"></a></h1><p><a href=\"https://spring.io/guides/gs/gateway/\" target=\"_blank\">https://spring.io/guides/gs/gateway/</a></p>\n<p><a href=\"https://cloud.spring.io/spring-cloud-gateway/reference/html/#gateway-starter\" target=\"_blank\">https://cloud.spring.io/spring-cloud-gateway/reference/html/#gateway-starter</a></p>\n","prev":{"title":"SpringGateway-RateLimiter","link":"2020/03/09/SpringCloudGateway-RateLimiter"},"next":{"title":"CAP理论","link":"2020/03/01/CAP理论"},"plink":"https://blog.bugbak.com/2020/03/06/SpringCloudGateway/","toc":[{"id":"搭建环境","title":"搭建环境","index":"1"},{"id":"spring-cloud-gateway是什么","title":"Spring Cloud Gateway是什么","index":"2"},{"id":"工作原理","title":"工作原理","index":"3"},{"id":"搭建一个spring-cloud-gateway项目","title":"搭建一个Spring Cloud Gateway项目","index":"4","children":[{"id":"配置路由的断言","title":"配置路由的断言","index":"4.1","children":[{"id":"时间断言","title":"时间断言","index":"4.1.1"},{"id":"http参数断言","title":"Http参数断言","index":"4.1.2"},{"id":"权重断言","title":"权重断言","index":"4.1.3"}]},{"id":"配置路由的过滤器","title":"配置路由的过滤器","index":"4.2","children":[{"id":"addrequestheader","title":"AddRequestHeader","index":"4.2.1"},{"id":"addrequestparameter","title":"AddRequestParameter","index":"4.2.2"},{"id":"addresponseheader","title":"AddResponseHeader","index":"4.2.3"},{"id":"deduperesponseheader","title":"DedupeResponseHeader","index":"4.2.4"},{"id":"circuitbreaker","title":"CircuitBreaker","index":"4.2.5"},{"id":"maprequestheader","title":"MapRequestHeader","index":"4.2.6"},{"id":"prefixpath","title":"PrefixPath","index":"4.2.7"},{"id":"preservehostheader","title":"PreserveHostHeader","index":"4.2.8"},{"id":"requestratelimiter","title":"RequestRateLimiter","index":"4.2.9"},{"id":"redirectto","title":"RedirectTo","index":"4.2.10"},{"id":"removerequestheader","title":"RemoveRequestHeader","index":"4.2.11"},{"id":"removeresponseheader","title":"RemoveResponseHeader","index":"4.2.12"},{"id":"removerequestparameter","title":"RemoveRequestParameter","index":"4.2.13"},{"id":"rewritepath","title":"RewritePath","index":"4.2.14"},{"id":"rewritelocationresponseheader","title":"RewriteLocationResponseHeader","index":"4.2.15"},{"id":"rewriteresponseheader","title":"RewriteResponseHeader","index":"4.2.16"},{"id":"savesession","title":"SaveSession","index":"4.2.17"},{"id":"secureheaders","title":"SecureHeaders","index":"4.2.18"},{"id":"setpath","title":"SetPath","index":"4.2.19"},{"id":"setrequestheader","title":"SetRequestHeader","index":"4.2.20"},{"id":"setresponseheader","title":"SetResponseHeader","index":"4.2.21"},{"id":"setstatus","title":"SetStatus","index":"4.2.22"},{"id":"stripprefix","title":"StripPrefix","index":"4.2.23"},{"id":"retry","title":"Retry","index":"4.2.24"},{"id":"requestsize","title":"RequestSize","index":"4.2.25"},{"id":"modifyrequestbody","title":"ModifyRequestBody","index":"4.2.26"},{"id":"modifyresponsebody","title":"ModifyResponseBody","index":"4.2.27"},{"id":"default-filters","title":"default-filters","index":"4.2.28"}]}]},{"id":"总结","title":"总结","index":"5"},{"id":"参考","title":"参考","index":"6"}],"reward":true,"copyright":{"author":"Dz","link":"<a href=\"https://blog.bugbak.com/2020/03/06/SpringCloudGateway/\" title=\"SpringCloudGateway\">https://blog.bugbak.com/2020/03/06/SpringCloudGateway/</a>","license":"本博客所有文章除特别声明外，均采用(<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"nofollow\" target=\"_blank\">CC BY-NC-SA 4.0</a>)许可协议，转载请注明来源<a href=\"https://blog.bugbak.com\" rel=\"nofollow\" target=\"_blank\">BugBak</a>"}}